# -*- coding: utf-8 -*-
"""RESEARCH_NOVELTY_EVALUATION_SYSTEM.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Rj2TuJViDyrLsicma0ogUxTL843jK6At

# üî¨ Research Novelty Evaluation System
### AI-Powered Academic Innovation Advisor
**Ultra v1 ¬∑ Semantic Search ¬∑ Transformer Summarization ¬∑ Innovation Scoring**

> Run each cell in order. The final cell launches the full interactive web UI.
"""

# ============================================================
# CELL 1 ‚Äî Install Dependencies
# ============================================================
import subprocess, sys

pkgs = [
    'flask',
    'flask-cors',
    'requests',
    'beautifulsoup4',
    'transformers',
    'torch',
    'sentence-transformers',
    'scikit-learn',
    'serpapi',
    'google-search-results',
    'lxml',
    'scholarly',
]

for pkg in pkgs:
    subprocess.run([sys.executable, '-m', 'pip', 'install', '-q', pkg], check=False)

print('‚úÖ All packages installed!')

# ============================================================
# CELL 2 ‚Äî Core Backend Logic
# ============================================================
import os, json, re, time, warnings, logging
warnings.filterwarnings('ignore')
logging.basicConfig(level=logging.ERROR)

import requests
from bs4 import BeautifulSoup
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np

# ‚îÄ‚îÄ Lazy-loaded models (loaded once on first use) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
_summarizer = None
_embedder   = None

def get_summarizer():
    global _summarizer
    if _summarizer is None:
        from transformers import pipeline
        _summarizer = pipeline(
            'summarization',
            model='sshleifer/distilbart-cnn-12-6',
            device=-1
        )
    return _summarizer

def get_embedder():
    global _embedder
    if _embedder is None:
        from sentence_transformers import SentenceTransformer
        _embedder = SentenceTransformer('all-MiniLM-L6-v2')
    return _embedder

# ‚îÄ‚îÄ 1. Idea Decomposition ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def decompose_idea(title: str, description: str) -> dict:
    """Extracts core technical components from idea."""
    text = f"{title} {description}".lower()

    tech_keywords = {
        'Deep Learning':      r'deep learning|neural network|cnn|rnn|lstm|gru',
        'NLP':                r'nlp|natural language|text|bert|gpt|transformer|llm|language model',
        'Computer Vision':    r'computer vision|image|video|detection|segmentation|recognition|opencv',
        'Reinforcement Learning': r'reinforcement|reward|agent|policy|q-learning|rl',
        'Generative AI':      r'gan|generative|diffusion|vae|stable diffusion|synthesis',
        'Graph Networks':     r'graph|gnn|gcn|knowledge graph|network topology',
        'Federated Learning': r'federated|distributed learning|privacy preserving|on-device',
        'Transfer Learning':  r'transfer|fine.?tun|pre.?train|domain adapt',
        'Multimodal AI':      r'multimodal|cross.?modal|vision.language|audio.visual',
        'Explainable AI':     r'explainab|interpret|xai|shap|lime|attention',
        'Healthcare AI':      r'medical|clinical|health|diagnosis|patient|drug|genomic',
        'Robotics':           r'robot|autonomous|drone|navigation|slam|path planning',
        'Optimization':       r'optim|genetic|evolutionary|swarm|particle|bayesian optim',
        'Edge Computing':     r'edge|iot|embedded|real.?time|low.?latency|mobile',
        'Security AI':        r'security|adversarial|attack|defense|anomaly|intrusion',
    }

    found = [k for k, pat in tech_keywords.items() if re.search(pat, text)]

    # Extract key noun phrases (simple approach)
    words = re.findall(r'\b[a-z][a-z-]{3,}\b', text)
    stopwords = {'with','that','this','from','have','been','will','using','based',
                 'approach','method','system','model','deep','learning','neural'}
    keywords = list(dict.fromkeys([w for w in words if w not in stopwords]))[:12]

    return {
        'domains':          found if found else ['General Machine Learning'],
        'keywords':         keywords,
        'search_queries':   generate_search_queries(title, found, keywords)
    }

def generate_search_queries(title, domains, keywords):
    queries = [title]
    for d in domains[:2]:
        queries.append(f"{d} {' '.join(keywords[:3])}")
    if keywords:
        queries.append(' '.join(keywords[:5]))
    return list(dict.fromkeys(queries))[:4]

# ‚îÄ‚îÄ 2. Google Scholar Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def search_scholar(query: str, num_results: int = 5) -> list:
    """Search via scholarly (no API key needed)."""
    try:
        from scholarly import scholarly as sc
        results = []
        gen = sc.search_pubs(query)
        for _ in range(num_results):
            try:
                pub = next(gen)
                bib = pub.get('bib', {})
                results.append({
                    'title':    bib.get('title', 'Unknown Title'),
                    'authors':  ', '.join(bib.get('author', ['Unknown'])[:3]),
                    'year':     bib.get('pub_year', 'N/A'),
                    'abstract': bib.get('abstract', '')[:500],
                    'citations': pub.get('num_citations', 0),
                    'url':      pub.get('pub_url', '') or f"https://scholar.google.com/scholar?q={requests.utils.quote(bib.get('title',''))}"
                })
                time.sleep(0.5)
            except StopIteration:
                break
            except Exception:
                continue
        return results
    except Exception as e:
        return search_scholar_scrape(query, num_results)

def search_scholar_scrape(query: str, num_results: int = 5) -> list:
    """Fallback: scrape Google Scholar directly."""
    headers = {'User-Agent': 'Mozilla/5.0 (compatible; ResearchBot/1.0)'}
    url = f"https://scholar.google.com/scholar?q={requests.utils.quote(query)}&hl=en&num={num_results}"
    papers = []
    try:
        resp = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(resp.text, 'lxml')
        for item in soup.select('.gs_ri')[:num_results]:
            title_tag = item.select_one('.gs_rt')
            title = title_tag.get_text(strip=True).replace('[PDF]','').replace('[HTML]','').strip() if title_tag else 'Unknown'
            link_tag = title_tag.find('a') if title_tag else None
            link = link_tag['href'] if link_tag else f"https://scholar.google.com/scholar?q={requests.utils.quote(title)}"
            meta = item.select_one('.gs_a')
            meta_text = meta.get_text() if meta else ''
            year_match = re.search(r'\b(19|20)\d{2}\b', meta_text)
            year = year_match.group(0) if year_match else 'N/A'
            authors_raw = meta_text.split('-')[0].strip() if '-' in meta_text else 'Unknown'
            snippet = item.select_one('.gs_rs')
            abstract = snippet.get_text(strip=True)[:400] if snippet else ''
            cited_tag = item.select_one('.gs_fl')
            cited_text = cited_tag.get_text() if cited_tag else ''
            cite_match = re.search(r'Cited by (\d+)', cited_text)
            citations = int(cite_match.group(1)) if cite_match else 0
            papers.append({
                'title': title, 'authors': authors_raw,
                'year': year, 'abstract': abstract,
                'citations': citations, 'url': link
            })
    except Exception as ex:
        print(f'Scholar scrape error: {ex}')
    return papers

def gather_all_papers(queries: list, per_query: int = 4) -> list:
    seen, papers = set(), []
    for q in queries:
        for p in search_scholar(q, per_query):
            if p['title'] not in seen:
                seen.add(p['title'])
                papers.append(p)
    return papers[:12]

# ‚îÄ‚îÄ 3. Summarization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def summarize_abstract(text: str) -> str:
    if not text or len(text) < 60:
        return text or 'No abstract available.'
    try:
        summ = get_summarizer()
        result = summ(text[:800], max_length=80, min_length=25, do_sample=False)
        return result[0]['summary_text']
    except Exception:
        return text[:300] + '...'

# ‚îÄ‚îÄ 4. Semantic Similarity ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def compute_similarity(idea_text: str, papers: list) -> list:
    if not papers:
        return []
    embedder = get_embedder()
    idea_emb = embedder.encode([idea_text])
    paper_texts = [f"{p['title']} {p['abstract']}" for p in papers]
    paper_embs  = embedder.encode(paper_texts)
    sims = cosine_similarity(idea_emb, paper_embs)[0]
    for i, p in enumerate(papers):
        p['similarity'] = round(float(sims[i]), 4)
    return sorted(papers, key=lambda x: x['similarity'], reverse=True)

# ‚îÄ‚îÄ 5. Novelty Assessment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def assess_novelty(papers: list, decomp: dict) -> dict:
    if not papers:
        return {'level': 'High', 'score': 90, 'confidence': 'Low (no papers found)'}
    sims = [p['similarity'] for p in papers if 'similarity' in p]
    avg_sim = np.mean(sims) if sims else 0
    max_sim = max(sims) if sims else 0
    # Score: lower similarity ‚Üí higher novelty
    raw = 1 - (avg_sim * 0.6 + max_sim * 0.4)
    score = int(round(raw * 100))
    score = max(10, min(98, score))
    if score >= 70:   level = 'High'
    elif score >= 45: level = 'Medium'
    else:             level = 'Low'
    return {
        'level': level, 'score': score,
        'avg_similarity': round(avg_sim, 3),
        'max_similarity': round(max_sim, 3),
        'confidence': 'High'
    }

# ‚îÄ‚îÄ 6. Gap & Improvement Analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def identify_gaps_and_suggestions(title, description, papers, decomp) -> dict:
    domains = decomp.get('domains', [])
    keywords = decomp.get('keywords', [])
    covered = set()
    for p in papers:
        t = (p['title'] + p['abstract']).lower()
        for kw in keywords:
            if kw in t:
                covered.add(kw)
    gaps = [kw for kw in keywords if kw not in covered][:6]

    # Domain-specific suggestions
    suggestions = [
        'Integrate multimodal data sources (text + vision + audio) for richer representations.',
        'Apply federated learning to enhance privacy and scalability across distributed datasets.',
        'Introduce explainability modules (SHAP / LIME / attention visualization) to improve interpretability.',
        'Benchmark on publicly available datasets such as MIMIC-III, ImageNet, MS-COCO, or GLUE.',
        'Leverage self-supervised pre-training on domain-specific corpora before fine-tuning.',
        'Combine symbolic AI reasoning with neural approaches for hybrid intelligence.',
        'Implement real-time edge-deployment optimization using quantization and pruning.',
        'Conduct ablation studies to isolate the contribution of each proposed module.',
    ]

    domain_recs = {
        'NLP':               ['Fine-tune LLaMA-3 or Mistral-7B on domain-specific corpora', 'Employ Chain-of-Thought prompting for reasoning tasks'],
        'Computer Vision':   ['Combine ViT + CNN hybrid for global-local feature extraction', 'Use SAM (Segment Anything Model) for zero-shot segmentation'],
        'Healthcare AI':     ['Integrate EHR structured data with clinical notes via cross-attention', 'Validate on FDA-approved benchmark datasets'],
        'Generative AI':     ['Explore latent diffusion models for high-fidelity synthesis', 'Evaluate using FID, CLIP score, and human evaluation'],
        'Reinforcement Learning': ['Implement PPO or SAC for stable policy optimization', 'Use Gymnasium / Isaac Sim for simulation'],
        'Multimodal AI':     ['Use CLIP or ALIGN for cross-modal alignment', 'Fuse modalities with cross-modal transformers'],
    }

    advanced_recs = []
    for d in domains:
        if d in domain_recs:
            advanced_recs.extend(domain_recs[d])
    advanced_recs = list(dict.fromkeys(advanced_recs))[:6]
    if not advanced_recs:
        advanced_recs = suggestions[:4]

    datasets = suggest_datasets(domains, keywords)

    return {
        'gaps': gaps if gaps else ['Scalability to large-scale datasets', 'Cross-domain generalization', 'Real-world deployment evaluation'],
        'suggestions': suggestions[:5],
        'advanced_techniques': advanced_recs,
        'datasets': datasets,
    }

def suggest_datasets(domains, keywords):
    all_datasets = {
        'NLP':               ['GLUE / SuperGLUE', 'SQuAD 2.0', 'Common Crawl', 'BIG-Bench'],
        'Computer Vision':   ['ImageNet-21K', 'MS-COCO', 'Open Images V7', 'LAION-5B'],
        'Healthcare AI':     ['MIMIC-III / MIMIC-IV', 'PhysioNet', 'NIH Chest X-ray', 'TCGA'],
        'Generative AI':     ['LAION-Aesthetics', 'CC12M', 'YFCC100M'],
        'Reinforcement Learning': ['OpenAI Gym', 'DeepMind Control Suite', 'Atari 2600'],
        'Graph Networks':    ['OGB (Open Graph Benchmark)', 'SNAP Datasets', 'TUDataset'],
        'Security AI':       ['NSL-KDD', 'CICIDS2017', 'UNSW-NB15'],
    }
    datasets = []
    for d in domains:
        datasets.extend(all_datasets.get(d, []))
    datasets = list(dict.fromkeys(datasets))
    if not datasets:
        datasets = ['UCI ML Repository', 'Kaggle Datasets', 'HuggingFace Datasets Hub']
    return datasets[:6]

# ‚îÄ‚îÄ 7. Final Verdict ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def build_verdict(novelty, gaps_info, decomp) -> str:
    level = novelty['level']
    score = novelty['score']
    num_gaps = len(gaps_info.get('gaps', []))
    if level == 'High':
        verdict = (f"üü¢ HIGH NOVELTY ({score}/100): Your idea presents a strong research opportunity. "
                   f"With {num_gaps} identified unexplored dimensions and low overlap with existing work, "
                   "this has significant potential for publication in top venues (NeurIPS, CVPR, ACL, etc.). "
                   "Focus on empirical validation and ablation studies to strengthen your contribution.")
    elif level == 'Medium':
        verdict = (f"üü° MEDIUM NOVELTY ({score}/100): Your idea shows promise but overlaps partially with existing work. "
                   "Differentiating your approach by incorporating the suggested advanced techniques and "
                   "targeting identified research gaps will significantly elevate your contribution. "
                   "Consider workshop papers at top conferences as an entry point.")
    else:
        verdict = (f"üî¥ LOW NOVELTY ({score}/100): Your idea is similar to several existing works. "
                   "A deeper pivot‚Äîsuch as combining domains, targeting an underexplored dataset, or "
                   "introducing a novel architectural component‚Äîis recommended before submission. "
                   "Revisit the innovation suggestions for actionable pivots.")
    return verdict

# ‚îÄ‚îÄ Master Pipeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def evaluate_research_idea(title: str, description: str, use_summarizer: bool = True) -> dict:
    """Full pipeline. Returns structured JSON result."""
    result = {'status': 'ok', 'title': title}

    # Step 1: Decompose
    decomp = decompose_idea(title, description)
    result['decomposition'] = decomp

    # Step 2: Search
    papers = gather_all_papers(decomp['search_queries'], per_query=4)
    if not papers:
        result['warning'] = 'No papers found. Scholar may be rate-limiting. Results generated with limited data.'

    # Step 3: Summarize
    if use_summarizer:
        for p in papers:
            p['summary'] = summarize_abstract(p['abstract'])
    else:
        for p in papers:
            p['summary'] = (p['abstract'][:250] + '...') if len(p['abstract']) > 250 else p['abstract']

    # Step 4: Similarity
    idea_text = f"{title} {description}"
    papers = compute_similarity(idea_text, papers)
    result['papers'] = papers

    # Step 5: Novelty
    novelty = assess_novelty(papers, decomp)
    result['novelty'] = novelty

    # Step 6: Gaps & Suggestions
    gaps_info = identify_gaps_and_suggestions(title, description, papers, decomp)
    result['gaps_info'] = gaps_info

    # Step 7: Verdict
    result['verdict'] = build_verdict(novelty, gaps_info, decomp)

    return result

print('‚úÖ Backend logic loaded!')

# ============================================================
# CELL 3 ‚Äî Flask API Server
# ============================================================
from flask import Flask, request, jsonify
from flask_cors import CORS
import threading

app = Flask(__name__)
CORS(app)

@app.route('/evaluate', methods=['POST'])
def evaluate():
    try:
        data = request.get_json(force=True)
        title  = data.get('title', '').strip()
        desc   = data.get('description', '').strip()
        fast   = data.get('fast_mode', False)
        if not title or not desc:
            return jsonify({'status': 'error', 'message': 'Title and description are required.'}), 400
        result = evaluate_research_idea(title, desc, use_summarizer=not fast)
        return jsonify(result)
    except Exception as e:
        import traceback
        return jsonify({'status': 'error', 'message': str(e), 'trace': traceback.format_exc()}), 500

@app.route('/health', methods=['GET'])
def health():
    return jsonify({'status': 'ok', 'message': 'Research Novelty Evaluation System is running!'})

def run_flask():
    app.run(host='0.0.0.0', port=8766, debug=False, use_reloader=False)

flask_thread = threading.Thread(target=run_flask, daemon=True)
flask_thread.start()
import time; time.sleep(2)
print('‚úÖ Flask API running on port 8766')

# ============================================================
# CELL 4 ‚Äî Generate Full-Screen HTML UI (written to file)
# ============================================================

HTML = r"""
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Research Novelty Evaluation System</title>
<style>
  :root {
    --bg:      #0a0e1a;
    --surface: #111827;
    --card:    #1a2235;
    --border:  #2a3a5c;
    --accent1: #4ade80;
    --accent2: #38bdf8;
    --accent3: #a78bfa;
    --accent4: #fb923c;
    --text:    #e2e8f0;
    --muted:   #94a3b8;
    --danger:  #f87171;
    --warn:    #fbbf24;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', system-ui, sans-serif;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  .header {
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
    border-bottom: 1px solid var(--border);
    padding: 24px 40px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .header::before {
    content: '';
    position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(99,102,241,0.15) 0%, transparent 70%);
  }
  .header h1 {
    font-size: 2.2rem;
    font-weight: 800;
    letter-spacing: 2px;
    background: linear-gradient(90deg, var(--accent2), var(--accent3), var(--accent1));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    position: relative;
  }
  .header .subtitle {
    color: var(--muted); font-size: 0.85rem;
    letter-spacing: 4px; margin-top: 6px; position: relative;
  }
  .badges { display: flex; gap: 8px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
  .badge {
    background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    border-radius: 20px; padding: 4px 14px; font-size: 0.75rem; color: var(--muted);
  }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .main { max-width: 1200px; margin: 0 auto; padding: 32px 24px; }

  /* ‚îÄ‚îÄ‚îÄ INPUT CARD ‚îÄ‚îÄ‚îÄ */
  .input-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px; margin-bottom: 32px;
    box-shadow: 0 4px 32px rgba(0,0,0,0.4);
  }
  .input-card h2 { font-size: 1.1rem; color: var(--accent2); margin-bottom: 20px; }
  label { display: block; font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; letter-spacing: 1px; text-transform: uppercase; }
  input[type=text], textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text); font-size: 0.95rem;
    padding: 12px 16px; outline: none; transition: border-color 0.2s;
    font-family: inherit;
  }
  input[type=text]:focus, textarea:focus { border-color: var(--accent3); }
  textarea { resize: vertical; min-height: 100px; }
  .form-row { margin-bottom: 18px; }
  .form-footer { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 8px; }
  .toggle-wrap { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--muted); }
  .toggle-wrap input[type=checkbox] { accent-color: var(--accent3); width: 16px; height: 16px; cursor: pointer; }

  /* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
  .btn-primary {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    border: none; border-radius: 10px; color: #fff;
    cursor: pointer; font-size: 1rem; font-weight: 700;
    letter-spacing: 1px; padding: 14px 36px;
    transition: all 0.2s; box-shadow: 0 4px 20px rgba(99,102,241,0.4);
  }
  .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(99,102,241,0.5); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-clear { background: transparent; border: 1px solid var(--border); border-radius: 10px; color: var(--muted); cursor: pointer; font-size: 0.85rem; padding: 10px 20px; transition: all 0.2s; }
  .btn-clear:hover { border-color: var(--accent3); color: var(--text); }

  /* ‚îÄ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ‚îÄ */
  #loader { display: none; text-align: center; padding: 40px; }
  .spinner {
    width: 48px; height: 48px; border-radius: 50%;
    border: 3px solid var(--border);
    border-top-color: var(--accent3);
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-steps { color: var(--muted); font-size: 0.85rem; }
  .step-item { padding: 4px 0; transition: color 0.3s; }
  .step-item.active { color: var(--accent2); font-weight: 600; }
  .step-item.done { color: var(--accent1); }

  /* ‚îÄ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ‚îÄ */
  #error-box { display: none; background: rgba(248,113,113,0.1); border: 1px solid var(--danger); border-radius: 12px; padding: 16px; margin-bottom: 24px; color: var(--danger); }

  /* ‚îÄ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ‚îÄ */
  #results { display: none; }
  .section { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; margin-bottom: 24px; }
  .section-title {
    font-size: 1rem; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; margin-bottom: 20px;
    padding-bottom: 12px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .section-icon { font-size: 1.3rem; }

  /* Decomposition */
  .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; }
  .tag {
    border-radius: 8px; padding: 6px 14px; font-size: 0.8rem; font-weight: 600;
    letter-spacing: 0.5px;
  }
  .tag-domain { background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.4); color: #a78bfa; }
  .tag-kw { background: rgba(56,189,248,0.1); border: 1px solid rgba(56,189,248,0.3); color: #38bdf8; }

  /* Papers */
  .paper-grid { display: grid; gap: 16px; }
  .paper-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 18px;
    transition: border-color 0.2s;
  }
  .paper-card:hover { border-color: var(--accent3); }
  .paper-card h4 { font-size: 0.95rem; color: var(--text); margin-bottom: 6px; }
  .paper-card h4 a { color: inherit; text-decoration: none; }
  .paper-card h4 a:hover { color: var(--accent2); }
  .paper-meta { font-size: 0.78rem; color: var(--muted); margin-bottom: 8px; }
  .paper-meta span { margin-right: 12px; }
  .paper-summary { font-size: 0.85rem; color: #cbd5e1; line-height: 1.6; }
  .sim-bar-wrap { margin-top: 10px; }
  .sim-label { font-size: 0.75rem; color: var(--muted); margin-bottom: 4px; display: flex; justify-content: space-between; }
  .sim-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .sim-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

  /* Novelty Score */
  .novelty-grid { display: grid; grid-template-columns: auto 1fr; gap: 32px; align-items: center; }
  .score-ring { position: relative; width: 140px; height: 140px; flex-shrink: 0; }
  .score-ring svg { transform: rotate(-90deg); }
  .score-text {
    position: absolute; inset: 0; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
  }
  .score-num { font-size: 2.2rem; font-weight: 800; }
  .score-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 1px; }
  .novelty-details { display: flex; flex-direction: column; gap: 12px; }
  .detail-row { display: flex; justify-content: space-between; align-items: center; }
  .detail-key { font-size: 0.85rem; color: var(--muted); }
  .detail-val { font-size: 0.9rem; font-weight: 600; }
  .level-badge { padding: 4px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; }
  .level-High   { background: rgba(74,222,128,0.15); color: var(--accent1); border: 1px solid rgba(74,222,128,0.4); }
  .level-Medium { background: rgba(251,191,36,0.15); color: var(--warn); border: 1px solid rgba(251,191,36,0.4); }
  .level-Low    { background: rgba(248,113,113,0.15); color: var(--danger); border: 1px solid rgba(248,113,113,0.4); }

  /* Gaps & Suggestions */
  .item-list { list-style: none; display: flex; flex-direction: column; gap: 10px; }
  .item-list li {
    padding: 12px 16px;
    background: var(--surface); border-radius: 10px;
    border-left: 3px solid var(--accent3);
    font-size: 0.88rem; line-height: 1.5;
  }
  .item-list.gaps li { border-left-color: var(--warn); }
  .item-list.advanced li { border-left-color: var(--accent1); }
  .item-list.datasets li { border-left-color: var(--accent4); font-family: monospace; letter-spacing: 0.5px; }
  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  .sub-section-title { font-size: 0.8rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; }

  /* Verdict */
  .verdict-box {
    background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.08));
    border: 1px solid rgba(139,92,246,0.3);
    border-radius: 14px; padding: 24px;
    font-size: 0.95rem; line-height: 1.8; color: #cbd5e1;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .novelty-grid, .two-col { grid-template-columns: 1fr; }
    .header h1 { font-size: 1.5rem; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>üî¨ RESEARCH NOVELTY EVALUATION SYSTEM</h1>
  <div class="subtitle">AI-POWERED ACADEMIC INNOVATION ADVISOR</div>
  <div class="badges">
    <span class="badge">üß† Transformer Summarization</span>
    <span class="badge">üîç Google Scholar Search</span>
    <span class="badge">üìä Semantic Similarity</span>
    <span class="badge">üí° Innovation Scoring</span>
    <span class="badge">üéØ Gap Analysis</span>
  </div>
</div>

<div class="main">

  <!-- Input -->
  <div class="input-card">
    <h2>üìã Describe Your Research Idea</h2>
    <div class="form-row">
      <label>Research Title</label>
      <input type="text" id="title" placeholder="e.g., Federated Learning for Medical Image Segmentation with Privacy Guarantees" />
    </div>
    <div class="form-row">
      <label>Description / Abstract</label>
      <textarea id="description" placeholder="Describe your research idea in detail ‚Äî the problem, proposed approach, methods, and expected contributions..."></textarea>
    </div>
    <div class="form-footer">
      <button class="btn-primary" onclick="evaluate()">üöÄ EVALUATE NOVELTY</button>
      <button class="btn-clear" onclick="clearAll()">‚úï Clear</button>
      <div class="toggle-wrap">
        <input type="checkbox" id="fast-mode" />
        <label for="fast-mode" style="text-transform:none; letter-spacing:0;">Fast Mode (skip transformer summarization)</label>
      </div>
    </div>
  </div>

  <!-- Error -->
  <div id="error-box"></div>

  <!-- Loader -->
  <div id="loader">
    <div class="spinner"></div>
    <div class="loader-steps">
      <div class="step-item" id="s1">üß© Decomposing idea into components...</div>
      <div class="step-item" id="s2">üîç Searching Google Scholar...</div>
      <div class="step-item" id="s3">üìñ Summarizing related papers...</div>
      <div class="step-item" id="s4">üîó Computing semantic similarity...</div>
      <div class="step-item" id="s5">üìä Assessing novelty & generating report...</div>
    </div>
  </div>

  <!-- Results -->
  <div id="results">

    <!-- 1. Idea Breakdown -->
    <div class="section">
      <div class="section-title"><span class="section-icon">üß©</span> 1. IDEA BREAKDOWN</div>
      <div style="margin-bottom:14px">
        <div class="sub-section-title">Detected Domains</div>
        <div class="tag-cloud" id="domains"></div>
      </div>
      <div style="margin-bottom:14px">
        <div class="sub-section-title">Key Concepts</div>
        <div class="tag-cloud" id="keywords"></div>
      </div>
      <div>
        <div class="sub-section-title">Search Queries Generated</div>
        <div class="tag-cloud" id="queries"></div>
      </div>
    </div>

    <!-- 2. Existing Similar Work -->
    <div class="section">
      <div class="section-title"><span class="section-icon">üìö</span> 2. EXISTING SIMILAR WORK</div>
      <div class="paper-grid" id="papers"></div>
    </div>

    <!-- 3. Comparative Analysis -->
    <div class="section">
      <div class="section-title"><span class="section-icon">‚öñÔ∏è</span> 3. COMPARATIVE ANALYSIS</div>
      <div id="comparative"></div>
    </div>

    <!-- 4. Novelty Score -->
    <div class="section">
      <div class="section-title"><span class="section-icon">üéØ</span> 4. NOVELTY SCORE</div>
      <div class="novelty-grid">
        <div class="score-ring">
          <svg width="140" height="140" viewBox="0 0 140 140">
            <circle cx="70" cy="70" r="58" fill="none" stroke="#1e293b" stroke-width="12"/>
            <circle id="score-circle" cx="70" cy="70" r="58" fill="none" stroke-width="12"
              stroke-linecap="round" stroke-dasharray="364.4" stroke-dashoffset="364.4"
              style="transition: stroke-dashoffset 1.2s ease"/>
          </svg>
          <div class="score-text">
            <span class="score-num" id="score-num">‚Äî</span>
            <span class="score-label">/ 100</span>
          </div>
        </div>
        <div class="novelty-details" id="novelty-details"></div>
      </div>
    </div>

    <!-- 5. Innovation Suggestions -->
    <div class="section">
      <div class="section-title"><span class="section-icon">üí°</span> 5. INNOVATION SUGGESTIONS</div>
      <div class="two-col">
        <div>
          <div class="sub-section-title">üï≥Ô∏è Research Gaps Identified</div>
          <ul class="item-list gaps" id="gaps"></ul>
        </div>
        <div>
          <div class="sub-section-title">üîß Improvements & Pivots</div>
          <ul class="item-list" id="suggestions"></ul>
        </div>
      </div>
      <div style="margin-top:24px">
        <div class="sub-section-title">üöÄ Advanced Techniques & Recommendations</div>
        <ul class="item-list advanced" id="advanced"></ul>
      </div>
      <div style="margin-top:24px">
        <div class="sub-section-title">üì¶ Recommended Datasets</div>
        <ul class="item-list datasets" id="datasets"></ul>
      </div>
    </div>

    <!-- 6. Final Verdict -->
    <div class="section">
      <div class="section-title"><span class="section-icon">üìù</span> 6. FINAL VERDICT</div>
      <div class="verdict-box" id="verdict"></div>
    </div>

  </div>
</div>

<script>
const API = 'http://localhost:8766';
let stepTimer;

function animateSteps() {
  const steps = ['s1','s2','s3','s4','s5'];
  let i = 0;
  clearInterval(stepTimer);
  steps.forEach(s => { document.getElementById(s).className = 'step-item'; });
  stepTimer = setInterval(() => {
    if (i > 0) document.getElementById(steps[i-1]).className = 'step-item done';
    if (i < steps.length) { document.getElementById(steps[i]).className = 'step-item active'; i++; }
    else clearInterval(stepTimer);
  }, 2800);
}

function simColor(sim) {
  if (sim > 0.7) return '#f87171';
  if (sim > 0.45) return '#fbbf24';
  return '#4ade80';
}

async function evaluate() {
  const title = document.getElementById('title').value.trim();
  const desc  = document.getElementById('description').value.trim();
  const fast  = document.getElementById('fast-mode').checked;
  if (!title || !desc) { alert('Please fill in both the title and description.'); return; }

  document.getElementById('error-box').style.display = 'none';
  document.getElementById('results').style.display = 'none';
  document.getElementById('loader').style.display = 'block';
  document.querySelector('.btn-primary').disabled = true;
  animateSteps();

  try {
    const res = await fetch(API + '/evaluate', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({title, description: desc, fast_mode: fast})
    });
    const data = await res.json();
    clearInterval(stepTimer);
    document.getElementById('loader').style.display = 'none';
    document.querySelector('.btn-primary').disabled = false;
    if (data.status === 'error') throw new Error(data.message);
    renderResults(data);
  } catch(e) {
    clearInterval(stepTimer);
    document.getElementById('loader').style.display = 'none';
    document.querySelector('.btn-primary').disabled = false;
    const eb = document.getElementById('error-box');
    eb.style.display = 'block';
    eb.innerHTML = '<strong>‚ö†Ô∏è Error:</strong> ' + e.message + '<br><small>Make sure the Flask server is running (Cell 3). If Scholar is blocked, try Fast Mode.</small>';
  }
}

function renderResults(data) {
  // 1. Decomposition
  const d = data.decomposition || {};
  document.getElementById('domains').innerHTML =
    (d.domains || []).map(t => `<span class="tag tag-domain">${t}</span>`).join('');
  document.getElementById('keywords').innerHTML =
    (d.keywords || []).map(t => `<span class="tag tag-kw">${t}</span>`).join('');
  document.getElementById('queries').innerHTML =
    (d.search_queries || []).map(q => `<span class="tag" style="background:rgba(251,146,60,0.1);border-color:rgba(251,146,60,0.3);color:#fb923c;font-size:0.75rem">${q}</span>`).join('');

  // 2. Papers
  const papers = data.papers || [];
  document.getElementById('papers').innerHTML = papers.length ? papers.map((p,i) => {
    const sim = p.similarity || 0;
    const pct = Math.round(sim * 100);
    return `
    <div class="paper-card">
      <h4><a href="${p.url}" target="_blank">${i+1}. ${p.title}</a></h4>
      <div class="paper-meta">
        <span>üë§ ${p.authors || 'Unknown'}</span>
        <span>üìÖ ${p.year || 'N/A'}</span>
        <span>üìä Cited by ${p.citations || 0}</span>
      </div>
      <div class="paper-summary">${p.summary || p.abstract || 'No summary available.'}</div>
      <div class="sim-bar-wrap">
        <div class="sim-label"><span>Semantic Similarity</span><span style="color:${simColor(sim)}">${pct}%</span></div>
        <div class="sim-bar"><div class="sim-fill" style="width:${pct}%;background:${simColor(sim)}"></div></div>
      </div>
    </div>`;
  }).join('') : '<p style="color:var(--muted)">No papers found. Scholar may be temporarily unavailable.</p>';

  // 3. Comparative Analysis
  const n = data.novelty || {};
  const avgSim = n.avg_similarity || 0;
  const maxSim = n.max_similarity || 0;
  document.getElementById('comparative').innerHTML = `
    <p style="color:#cbd5e1;line-height:1.8;font-size:0.9rem">
      Analysis of <strong style="color:var(--accent2)">${papers.length} papers</strong> from Google Scholar reveals an average semantic similarity of
      <strong style="color:${simColor(avgSim)}">${Math.round(avgSim*100)}%</strong> with your idea
      (peak: <strong style="color:${simColor(maxSim)}">${Math.round(maxSim*100)}%</strong>).
      ${avgSim < 0.35 ? '‚úÖ Your idea differs substantially from the surveyed literature.' :
        avgSim < 0.6  ? '‚ö†Ô∏è There is moderate overlap ‚Äî targeted differentiation is recommended.' :
                        'üî¥ High overlap detected. Significant pivoting is advised.'}
      The most related work is <em>"${papers[0]?.title || 'N/A'}"</em>.
    </p>
  `;

  // 4. Novelty Score
  const score = n.score || 50;
  const level = n.level || 'Medium';
  const circumference = 364.4;
  const offset = circumference - (score / 100) * circumference;
  const color = level === 'High' ? '#4ade80' : level === 'Medium' ? '#fbbf24' : '#f87171';
  document.getElementById('score-num').textContent = score;
  document.getElementById('score-num').style.color = color;
  const circle = document.getElementById('score-circle');
  circle.style.stroke = color;
  setTimeout(() => { circle.style.strokeDashoffset = offset; }, 100);
  document.getElementById('novelty-details').innerHTML = `
    <div class="detail-row"><span class="detail-key">Novelty Level</span><span class="level-badge level-${level}">${level}</span></div>
    <div class="detail-row"><span class="detail-key">Innovation Score</span><span class="detail-val" style="color:${color}">${score} / 100</span></div>
    <div class="detail-row"><span class="detail-key">Avg. Similarity</span><span class="detail-val">${Math.round(avgSim*100)}%</span></div>
    <div class="detail-row"><span class="detail-key">Max. Similarity</span><span class="detail-val">${Math.round(maxSim*100)}%</span></div>
    <div class="detail-row"><span class="detail-key">Papers Analyzed</span><span class="detail-val">${papers.length}</span></div>
    <div class="detail-row"><span class="detail-key">Confidence</span><span class="detail-val">${n.confidence || 'High'}</span></div>
  `;

  // 5. Gaps & Suggestions
  const gi = data.gaps_info || {};
  document.getElementById('gaps').innerHTML = (gi.gaps || []).map(g => `<li>üï≥Ô∏è ${g}</li>`).join('');
  document.getElementById('suggestions').innerHTML = (gi.suggestions || []).map(s => `<li>${s}</li>`).join('');
  document.getElementById('advanced').innerHTML = (gi.advanced_techniques || []).map(a => `<li>‚ö° ${a}</li>`).join('');
  document.getElementById('datasets').innerHTML = (gi.datasets || []).map(ds => `<li>üì¶ ${ds}</li>`).join('');

  // 6. Verdict
  document.getElementById('verdict').innerHTML = data.verdict || 'Evaluation complete.';

  document.getElementById('results').style.display = 'block';
  document.getElementById('results').scrollIntoView({behavior: 'smooth'});
}

function clearAll() {
  document.getElementById('title').value = '';
  document.getElementById('description').value = '';
  document.getElementById('results').style.display = 'none';
  document.getElementById('error-box').style.display = 'none';
}
</script>
</body>
</html>
"""

with open('/content/research_novelty_ui.html', 'w') as f:
    f.write(HTML)

print('‚úÖ UI HTML written to /content/research_novelty_ui.html')

# ============================================================
# CELL 5 ‚Äî Launch via Colab HTTPS Proxy (like your example!)
# ============================================================
from google.colab import output
from google.colab.output import eval_js
import IPython

# Get the Colab proxy URL for port 8766 (Flask/API)
# We serve the HTML from a second mini server on port 8767

from http.server import HTTPServer, SimpleHTTPRequestHandler
import os, threading

os.chdir('/content')

class SilentHandler(SimpleHTTPRequestHandler):
    def log_message(self, format, *args): pass

html_server = HTTPServer(('0.0.0.0', 8767), SilentHandler)
html_thread = threading.Thread(target=html_server.serve_forever, daemon=True)
html_thread.start()

import time; time.sleep(1)

# Now patch the API URL inside the served HTML to use the colab proxy
api_url = eval_js("google.colab.kernel.proxyPort(8766)")
ui_url  = eval_js("google.colab.kernel.proxyPort(8767)")

# Re-write HTML with correct API URL
with open('/content/research_novelty_ui.html', 'r') as f:
    content = f.read()
content = content.replace("const API = 'http://localhost:8766'", f"const API = '{api_url}'")
with open('/content/research_novelty_ui.html', 'w') as f:
    f.write(content)

# Build the full URL
full_ui_url = ui_url.rstrip('/') + '/research_novelty_ui.html'

# Display the launch button ‚Äî identical style to your example image!
launch_html = f"""
<style>
  body {{ background: #0f1117; }}
  .launch-wrap {{
    background: linear-gradient(135deg, #0f1117, #1a1f2e, #0f1117);
    border: 1px solid #2a3a5c;
    border-radius: 20px;
    padding: 36px 48px;
    text-align: center;
    font-family: 'Segoe UI', sans-serif;
    max-width: 600px;
    margin: 20px auto;
    box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  }}
  .launch-title {{
    font-size: 1.8rem; font-weight: 800; letter-spacing: 2px;
    background: linear-gradient(90deg, #38bdf8, #a78bfa, #4ade80);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    margin-bottom: 6px;
  }}
  .launch-sub {{ color: #64748b; font-size: 0.75rem; letter-spacing: 4px; margin-bottom: 28px; }}
  .launch-btn {{
    display: inline-block;
    background: linear-gradient(135deg, #38bdf8, #8b5cf6);
    color: #fff; font-weight: 800; font-size: 1.05rem;
    letter-spacing: 2px; text-decoration: none;
    padding: 16px 48px; border-radius: 12px;
    box-shadow: 0 6px 28px rgba(139,92,246,0.45);
    transition: all 0.2s;
    cursor: pointer;
  }}
  .launch-btn:hover {{ transform: translateY(-2px); box-shadow: 0 10px 36px rgba(139,92,246,0.6); }}
  .badges-row {{ display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 20px 0; }}
  .b {{ background: rgba(255,255,255,0.04); border: 1px solid #2a3a5c; border-radius: 20px; padding: 4px 14px; font-size: 0.73rem; color: #64748b; }}
  .url-box {{ background: rgba(255,255,255,0.03); border: 1px solid #2a3a5c; border-radius: 8px; padding: 10px 16px; font-size: 0.78rem; color: #4ade80; font-family: monospace; margin-top: 16px; word-break: break-all; }}
  .note {{ color: #475569; font-size: 0.75rem; margin-top: 12px; }}
</style>
<div class="launch-wrap">
  <div class="launch-title">üî¨ RESEARCH NOVELTY SYSTEM</div>
  <div class="launch-sub">AI ADVISOR ¬∑ SCHOLAR SEARCH ¬∑ INNOVATION SCORING</div>
  <a class="launch-btn" href="{full_ui_url}" target="_blank">üöÄ OPEN FULL SCREEN</a>
  <div class="badges-row">
    <span class="b">üß† Transformer NLP</span>
    <span class="b">üîç Scholar Search</span>
    <span class="b">üìä Novelty Score</span>
    <span class="b">üí° Gap Analysis</span>
    <span class="b">‚ö° Zero Config</span>
  </div>
  <div class="url-box">üîó {full_ui_url}</div>
  <div class="note">Served via Colab HTTPS proxy ¬∑ Camera access not required<br>If the tab closes, re-click the button ‚Äî server stays running</div>
</div>
"""

IPython.display.display(IPython.display.HTML(launch_html))
print(f'\n‚úÖ Server running on port 8767')
print(f'üîó App URL: {full_ui_url}')
print('‚ö†Ô∏è  Keep this cell running ‚Äî the server stops when the kernel restarts')